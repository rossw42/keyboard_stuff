# Integrated Plate Example - 2x2 Keyboard
# Plate and top case are one piece
# Very rigid construction, simplified assembly

meta:
  engine: 4.1.0
  name: integrated_plate_example
  version: 1.0

units:
  # Standard MX key spacing
  kx: 19.05
  ky: 19.05
  
  # Minimalistic parameters
  case_wall: 2.0
  case_height: 8  # Low profile
  integrated_thickness: 3  # Thicker for integrated design
  
  # Mounting parameters
  mount_hole_diameter: 2.2

points:
  zones:
    matrix:
      key:
        padding: ky
        spread: kx
        tags: [key, switch]
      columns:
        col0:
        col1:
      rows:
        row0:
        row1:

outlines:
  # Switch cutouts
  switch_cutouts:
    - what: rectangle
      where: [switch]
      size: [14, 14]
      operation: add

  # PCB outline
  board:
    - what: polygon
      operation: stack
      fillet: 2
      points:
        - ref: matrix_col0_row0
          shift: [-10, -10]
        - ref: matrix_col1_row0
          shift: [10, -10]
        - ref: matrix_col1_row1
          shift: [10, 10]
        - ref: matrix_col0_row1
          shift: [-10, 10]

  # Integrated top case/plate outline
  integrated_top:
    - what: outline
      name: board
      expand: case_wall
      fillet: 2

  # Bottom case outline
  case_bottom:
    - what: outline
      name: integrated_top

  # Mounting boss areas for reinforcement
  mount_bosses:
    - what: circle
      where: matrix_col0_row0
      radius: 4
      adjust:
        shift: [-12, -12]  # Bottom left
    - what: circle
      where: matrix_col1_row0
      radius: 4
      adjust:
        shift: [12, -12]  # Bottom right
    - what: circle
      where: matrix_col1_row1
      radius: 4
      adjust:
        shift: [12, 12]  # Top right
    - what: circle
      where: matrix_col0_row1
      radius: 4
      adjust:
        shift: [-12, 12]  # Top left

  # Mounting holes
  mount_holes:
    - what: circle
      where: matrix_col0_row0
      radius: 1.1  # M2 screw clearance
      adjust:
        shift: [-12, -12]  # Bottom left
    - what: circle
      where: matrix_col1_row0
      radius: 1.1
      adjust:
        shift: [12, -12]  # Bottom right
    - what: circle
      where: matrix_col1_row1
      radius: 1.1
      adjust:
        shift: [12, 12]  # Top right
    - what: circle
      where: matrix_col0_row1
      radius: 1.1
      adjust:
        shift: [-12, 12]  # Top left

  # Threaded inserts (larger holes for heat-set inserts)
  threaded_inserts:
    - what: circle
      where: matrix_col0_row0
      radius: 2.0  # M3 heat-set insert
      adjust:
        shift: [-12, -12]  # Bottom left
    - what: circle
      where: matrix_col1_row0
      radius: 2.0
      adjust:
        shift: [12, -12]  # Bottom right
    - what: circle
      where: matrix_col1_row1
      radius: 2.0
      adjust:
        shift: [12, 12]  # Top right
    - what: circle
      where: matrix_col0_row1
      radius: 2.0
      adjust:
        shift: [-12, 12]  # Top left

cases:
  # Bottom case
  bottom_case:
    - name: case_bottom
      extrude: case_height
    - name: mount_bosses
      extrude: case_height
      operation: add
    - name: threaded_inserts
      extrude: 3
      operation: subtract

  # Integrated plate/top case (single piece)
  integrated_plate_case:
    - name: integrated_top
      extrude: integrated_thickness
    # Switch cutouts directly in case geometry
    - name: switch_cutouts
      extrude: integrated_thickness
      operation: subtract
    - name: mount_bosses
      extrude: integrated_thickness
      operation: add
    - name: mount_holes
      extrude: integrated_thickness + 1
      operation: subtract

  # Complete assembly
  complete_assembly:
    # Bottom case
    - name: case_bottom
      extrude: case_height
    - name: mount_bosses
      extrude: case_height
      operation: add
    # Integrated top
    - name: integrated_top
      extrude: integrated_thickness
      shift: [0, 0, case_height]
      operation: add
    - name: mount_bosses
      extrude: integrated_thickness
      shift: [0, 0, case_height]
      operation: add
    # Switch cutouts in integrated piece
    - name: switch_cutouts
      extrude: integrated_thickness
      shift: [0, 0, case_height]
      operation: subtract
    # Mounting holes
    - name: mount_holes
      extrude: case_height + integrated_thickness + 1
      operation: subtract
    # Threaded inserts in bottom
    - name: threaded_inserts
      extrude: 3
      operation: subtract

pcbs:
  main:
    outlines:
      main:
        outline: board
      holes:
        outline: mount_holes
        layer: Edge.Cuts